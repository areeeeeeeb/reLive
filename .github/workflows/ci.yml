name: CI

# Runs on every pull request targeting main.
# Acts as a gate — PRs that fail build or tests should not be merged.
on:
  pull_request:
    branches: [main]
    paths:
      - "backend-go/**"      # only run when Go backend files are changed
      - ".github/workflows/ci.yml"

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      # Check out the repo so the workflow has access to the source code
      - name: Checkout
        uses: actions/checkout@v4

      # Install the Go version matching go.mod
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: backend-go/go.mod
          cache-dependency-path: backend-go/go.sum

      # Verify the code compiles cleanly with no build errors
      - name: Build check
        working-directory: backend-go
        run: go build ./...

      # Static analysis — catches common bugs (nil pointer issues, unreachable code, etc.)
      # Faster than tests and catches a different class of problems
      - name: Vet check
        working-directory: backend-go
        run: go vet ./...

      # Run all tests — fails the PR if any test fails
      - name: Test check
        working-directory: backend-go
        run: go test ./...

      # Scan Go dependencies against the Go CVE database.
      # Catches known vulnerabilities in packages the code actually uses (not just imports).
      - name: Vulnerability scan
        working-directory: backend-go
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...
